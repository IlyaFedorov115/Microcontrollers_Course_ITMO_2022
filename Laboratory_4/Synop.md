# Таймеры, DMA, передача контроллер - Matlab


Таймеры микроконтроллеров STM32 можно поделить на следующие категории:

• Продвинутые (Advanced Timers)

• Общего назначения (General Purpose Timers, сокращенно GP)

• Базовые (Basic Timers)



![image](https://user-images.githubusercontent.com/42892348/208836711-4cb6365b-4d5f-4e38-b094-1dc7383d4b34.png)

![image](https://user-images.githubusercontent.com/42892348/208838780-99d8ce89-38d1-4859-8206-8c1b5b61d2b0.png)



> При разработке кода для таймеров следует учитывать следующие моменты:
**
• Перед использованием модули таймеров **должны быть** сначала разрешены установкой соответствующих бит в регистре **RCC_APBx_ENR**. Работа отдельных счетчиков, функций DMA и прерываний разрешается после настройки всего остального.

• Сразу после сброса при включении питания каждый бит внутренних регистров микроконтроллера STM32 устанавливается в свое **значение по умолчанию**. Для регистров таймера значение по умолчанию это все нули, что означает запрет всех функций. Таким образом, не нужно эти биты принудительно очищать при старте (точно так же обстоят дела и с любым другим периферийным устройством STM32). Однако если Вам нужно поменять кое-что на лету, то лучше всего сначала сбросить все настройки, чтобы не попасть в ситуацию непредсказуемого поведения таймеров и обслуживающего их кода.

• Помните, что периферийные устройства, подключенные к шине APB2, могут работать на максимальной системной тактовой частоте, в то время как периферийные устройства шины APB1 ограничены половиной этой скорости. Таким образом, таймеры APB1 не могут работать на той же тактовой частоте, как таймеры APB2


Счетчик таймера управляется двумя регистрами:

• TIMx_CNT, используется для чтения и записи содержимого счетчика таймера.
• TIMx_ARR, содержит значение для автоматической перезагрузки счетчика таймера.

Автоматическая перезагрузка счетчика работает следующим образом. Если счетчик таймера считает вверх, и достиг значения содержимого регистра TIMx_ARR, то счетчик таймера сбрасывается и начинается новый цикл счета. Если счетчик считает вниз, и достиг нуля, то в счетчик загружается значение из регистра TIMx_ARR, и начинается новый цикл счета.

Каждый раз, когда начинается новый цикл счета, срабатывает "событие обновления" таймера, пока счетчик повторений (repetition counter) равен 0. Если счетчик повторений не равен 0, то событие обновление не сработает, но перезапустится новый цикл счета, и содержимое счетчика повторений уменьшится на 1. Когда содержимое счетчика повторений достигнет нуля, произойдет событие обновления, и в счетчик повторений загрузится значение, сохраненное в регистре TIMx_RCR.

Не у всех таймеров STM32 есть счетчик повторений. Если его нет, то таймер ведет себя так, как если бы счетчик повторений был всегда равен 0.


> UEV – сигнал аппаратного события. Появляется при перезагрузке таймера.
> UIF – бит регистра состояния таймера (флаг прерывания).
> * Становится активным по UEV.
> * Инициирует прерывание, при разрешении в регистрах конфигурации.
> * Сбрасывается только программно после обработки прерывания.
> UIE – бит разрешения прерывания. Необходим для формирования запроса прерывания от таймера.


### TIMx_CR1

Регистр управления. Задает режим работы таймера.

![image](https://user-images.githubusercontent.com/42892348/208856390-416b4b38-99a4-4f70-8a7d-3ec0e7291875.png)

- Биты 9-8 (CKD) задают значение делителя частоты для внутренних нужд таймера.
- Бит 7 (ARPE) определяет режим записи в регистр перезагрузки: буферизирован или нет.
- Биты 6-5  (CMS) определяют режим для двунаправленного счета (01-11) или разрешают счет только в одном направлении (00).
- Бит 4 (DIR) задает направление счета: прямой или реверсивный (0 или 1).
- Битом 3 (OPM) можно задать режим одиночного импульса. Если он равен 1, то при перезагрузке счетчик останавливается.
- Бит 2 (URS) меняет логику формирования события UEV. При 0, к естественному формированию события перезагрузки таймера добавляются, программная инициация события с помощью бита UG и перезагрузка от ведомого таймера.
- Бит 1 (UDIS) управляет разрешением перезагрузки счетчика. Если задать его равным 1, то автоматическая перезагрузка счетчика происходить не будет.
- Бит 0 (CEN) разрешает работу счетчика. Если он не установлен, то счетчик полностью отключен.

### TIMx_DIER

Регистр разрешения прерываний.
В нем нас интересует бит 0 (UIE) – разрешение прерывания по перезагрузке. Прерывание разрешено при состоянии бита равном 1.


### TIMx_SR

Регистр состояния. Содержит флаги прерываний.

Нам интересен бит 0 (UIF) – флаг прерывания по переполнению.

Этот бит устанавливается аппаратным обеспечением при событии обновления. Это очищается программным обеспечением.
0: Обновление не произошло.
1: Ожидание прерывания обновления. Этот бит устанавливается аппаратным обеспечением при обновлении регистров


