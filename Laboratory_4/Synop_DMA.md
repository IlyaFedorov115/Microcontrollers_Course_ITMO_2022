# DMA

> Direct memory access (DMA), или прямой доступ к памяти (ПДП) используется для быстрой передачи данных между памятью и периферийным устройством, памятью и памятью, или между двумя периферийными устройствами без участия процессора.

> DMA1 в микроконтроллерах STM32F103c8 имеет 7 каналов, причем в конкретный момент времени передача данных может осуществляться только по одному из них. 



Каждый **канал DMA** имеет следующие регистры:

* DMA_CCRx — регистр конфигурации канала DMA. В нем содержатся биты конфигурации передачи данных, биты разрешения прерывания от канала и бит включения канала.
* DMA_CNDTRx — сколько кадров данных подлежит передаче (0..65535). Я намеренно употребил слово «кадр», а не «байт». Дело в том, то есть возможность настроить количество байт данных, которые передаются за одну транзакцию (настраивается в регистре DMA_CCRx), об этом поговорим далее.
* DMA_CMARx — адрес памяти. Если направление передачи из периферии в память, то сюда будем записывать данные, если обратно, то читать.
* DMA_CPARx — адрес периферийного устройства. Если направление передачи из периферии в память, то отсюда будем читать данные, если обратно, то записывать. В режиме Memory-to-memory сюда так же записывается адрес памяти.

Но это для случая, если нам надо передавать данные в периферию по одному байту. А что делать, если у нас разрядность массива 2 байта, и периферия хочет на вход 2 байта тоже?

Для таких случаев в регистре DMA_CCRx есть конфигурационные биты разрядности периферийного регистра (PSIZE) и разрядности данных в памяти (MSIZE). Они могут принимать следующие значения:

* 00: 8-bits
* 01: 16-bits
* 10: 32-bits
* 11: Reserved (эта комбинация не используется)


Каждый канал DMA имеет **3 прерывания**:

* Half-transfer — DMA передал половину данных, удобно при потоковой передаче данных совместно с кольцевым режимом: пока передаем одну половину массива, заполняем другую.
* Transfer complete — прерывание о завершении передачи данных.
* Transfer error — прерывание об ошибке передачи.

DMA1 в микроконтроллерах STM32F103C8 имеет 7 каналов передачи данных, причем на каждом канале висит своя периферия. Приведу таблицу из Reference manual, чтоб было понятнее:


![image](https://user-images.githubusercontent.com/42892348/208890866-cfb97748-cada-4bcb-9719-af39b721d3a7.png)


## Описание регистров DMA

В микроконтроллере STM32F103C8 контроллер DMA имеет 6 типов регистров. Организованы они следующим образом.

Регистры, которые являются общими для всех каналов DMA:

* DMA_ISR — регистр статуса прерываний
* DMA_IFCR — регистр очистки флагов прерываний
Регистры, которые являются индивидуальными для каждого канала DMA:

* DMA_CCRx (x=1..7) — регистр конфигурации канала номер x DMA
* DMA_CNDTRx (x=1..7) — регистр количества передаваемых данных канала номер x DMA
* DMA_CPARx (x=1..7) — регистр адреса периферии канала номер x DMA
* DMA_CMARx (x=1..7) — регистр адреса памяти канала номер x DMA

Количество каналов у нас 7. Тогда общее число регистров DMA1 у нас будет 7*4 + 2 = 30 штук.

### DMA_ISR

![image](https://user-images.githubusercontent.com/42892348/208891106-57f5445f-fe01-4402-8225-4bea67f42924.png)

Содержит флаги прерываний от всех каналов DMA.

* TEIFx: ошибка передачи канала DMA. Устанавливается аппаратно. Сбрасывается записью 1 в соответствующий бит регистра DMA_IFCR.
* HTIFx: флаг передачи половины данных каналом DMA. Устанавливается аппаратно. Сбрасывается записью 1 в соответствующий бит регистра DMA_IFCR.
* TCIFx: флаг конца передачи канала DMA. Устанавливается аппаратно. Сбрасывается записью 1 в соответствующий бит регистра DMA_IFCR.
* GIFx: глобальный флаг прерывания канала DMA. Устанавливается в 1, когда произошло событие TE, HT или TC данного канала. Устанавливается аппаратно. Сбрасывается записью 1 в соответствующий бит регистра DMA_IFCR.

### DMA_IFCR

![image](https://user-images.githubusercontent.com/42892348/208891298-66613650-d8b8-4a23-be1d-b54a3cb80367.png)


Установка в единицу любого бита в регистре DMA_IFCR очищает флаг соответствующего прерывания в регистре DMA_ISR. Запись нуля в любой бит не оказывает ни какого эффекта.

* CTEIFx: очистить флаг ошибки передачи канала DMA
* CHTIFx: очистить флаг передачи половины данных
* CTCIFx: очистить флаг завершения передачи
* CGIFx: очистить глобальный флаг прерывания DMA

### DMA_CCRx

![image](https://user-images.githubusercontent.com/42892348/208891417-ccca1b7c-0821-4849-a878-045ee6a12b9f.png)


MEM2MEM: режим «из памяти в память»

* 0 — режим MEM2MEM отключен
* 1 — режим MEM2MEM включен

PL[1:0]: уровень приоритета канала DMA

* 00: Low (Низкий приоритет)
* 01: Medium (Средний приоритет)
* 10: High (Высокий приоритет)
* 11: Very high (Очень высокий приоритет)

MSIZE[1:0]: разрядность данных в памяти

* 00: 8 бит
* 01: 16 бит
* 10: 32 бита
* 11: не используется

PSIZE[1:0]: разрядность периферии

* 00: 8 бит
* 01: 16 бит
* 10: 32 бита
* 11: не используется

MINC: режим инкремента памяти

* 0 — режим инкремента памяти отключен
* 1 — режим инкремента памяти включен

PINC: режим инкремента периферии

* 0 — режим инкремента периферии отключен
* 1 — режим инкремента периферии включен

CIRC: кольцевой режим DMA (Circular mode)

* 0 — кольцевой режим отключен
* 1 — кольцевой режим включен

DIR: направление передачи данных

* 0 — чтение из периферии (направление из периферии в память)
* 1 — чтение из памяти (направление из памяти в периферию)

TEIE: разрешить прерывание ошибки передачи DMA

* 0 — прерывание запрещено
* 1 — прерывание разрешено

HTIE: разрешить прерывание передачи половины буфера

0 — прерывание запрещено
1 — прерывание разрешено

TCIE: разрешить прерывание об окончании передачи

* 0 — прерывание запрещено
* 1 — прерывание разрешено

EN: включить канал DMA

* 0 — канал отключен
* 1 — канал включен


### DMA_CNDTRx

![image](https://user-images.githubusercontent.com/42892348/208891710-50a60909-a821-448c-b521-68f57be96995.png)

NDT[15:0]: количество данных для передачи.

Количество данных для передачи может быть от 0 до 65535. Этот регистр может быть записан только если данный канал DMA отключен (EN=0 в регистре DMA_CCRx). Когда канал DMA включен, этот регистр является только для чтения (read-only) и показывает, сколько транзакций DMA еще осталось. Этот регистр уменьшается на единицу после каждой транзакции DMA. Как только передача завершена, этот регистр либо остается в нуле, либо автоматически перезагружается изначально записанным в него значением, если включен кольцевой режим. Если этот регистр равен нулю, ни одна транзакция DMA не может быть выполнена, вне зависимости от того, включен ли данный канал, или нет.


### DMA_CMARx

![image](https://user-images.githubusercontent.com/42892348/208891769-dc6f411e-1fa8-4339-b165-d3168667fc95.png)

Этот регистр не может быть записан, когда данный канал DMA включен

MA[31:0]: адрес памяти.

Базовый адрес (указатель) области памяти, которую необходимо записать/прочитать. Когда MSIZE=01 (разрядность памяти 16 бит) бит MA[0] игнорируется. Доступ автоматически выравнивается с адресом в пол-слова. Когда MSIZE=10 (разрядность памяти 32 бита), биты MA[1:0] игнорируются.  Доступ автоматически выравнивается с адресом в машинное слово.

Примечание. Получается, что при передаче массива данных по DMA по 16 или 32 бита, надо помнить, что элементы передаваемого массива в памяти должны быть выравнены по границе 16 или 32 бита соответственно. Если в коде на Си передаваемый массив объявлен как int16_t/uint16_t, и передача этого массива осуществляется по 16 бит, то проблем возникнуть не должно, так как компилятор по-умолчанию выравнивает данные массива по соответствующей границе (но это не точно). То же самое и для int32_t/uint32_t массивов и передачи данных по DMA по 32 бита. Так же проблем не должно быть при передаче массивов  int32_t/uint32_t по 16 бит за раз. А вот если мы объявили  int8_t/uint8_t, и хотим его передать куда-либо по 16 или 32 бита за раз, то в этом случае могут возникнуть проблемы. С регистрами периферийных устройств таких проблем нет, так как они все выравнены по границе 32 бита. 

### DMA_CPARx

![image](https://user-images.githubusercontent.com/42892348/208891854-94709f6e-bba4-4ec1-94dc-cbe7499c353c.png)


Этот регистр не может быть записан, когда данный канал DMA включен

PA[31:0]: адрес периферии

Базовый адрес (указатель) области памяти, которую необходимо записать/прочитать. Когда MSIZE=01 (разрядность памяти 16 бит) бит MA[0] игнорируется. Доступ автоматически выравнивается с адресом в пол-слова. Когда MSIZE=10 (разрядность памяти 32 бита), биты MA[1:0] игнорируются.  Доступ автоматически выравнивается с адресом в машинное слово.

См. Примечание к регистру DMA_CMARx


# Прерывания DMA

В stm32f103c8 каждый канал DMA может генерировать 3 типа прерываний:

Передача данных завершена
Завершена передача половины данных
Ошибка передачи данных (возникает при обращении к зарезервированной области данных)
Для каждого канала нужные прерывания можно включить индивидуально в регистре конфигурации канала DMA_CCRx. За это отвечают биты TCIE (завершение передачи), HTIE ( передана половина буфера) и TEIE (ошибка передачи):

![image](https://user-images.githubusercontent.com/42892348/208892938-6ecd8690-e753-4bca-a933-b84fe7ff8b77.png)


Кроме того, есть еще 2 специальных регистра, один из которых содержит информацию об активных флагах прерываний всех каналов DMA (регистр DMA_ISR), а с помощью другого можно сбросить нужные флаги прерываний выбранных каналов (регистр DMA_IFCR):

![image](https://user-images.githubusercontent.com/42892348/208892971-bcee038e-fc3b-4941-846a-f671dbd2e127.png)


Регистр статуса прерываний DMA_ISR

![image](https://user-images.githubusercontent.com/42892348/208893006-a5409f50-091c-4f8e-baab-43bb382f332b.png)


Регистр сброса флагов прерываний DMA_IFCR




